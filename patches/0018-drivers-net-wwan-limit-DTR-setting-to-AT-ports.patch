From 993275125f33cd379e19360adc8b6a0b95c6a170 Mon Sep 17 00:00:00 2001
From: Daniele Palmas <dnlplm@gmail.com>
Date: Mon, 17 Oct 2022 11:43:35 +0200
Subject: [PATCH 18/19] drivers: net: wwan: limit DTR setting to AT ports

Signed-off-by: Daniele Palmas <dnlplm@gmail.com>
---
 drivers/net/wwan/mhi_wwan_ctrl.c | 18 ++++++++++++------
 1 file changed, 12 insertions(+), 6 deletions(-)

diff --git a/drivers/net/wwan/mhi_wwan_ctrl.c b/drivers/net/wwan/mhi_wwan_ctrl.c
index ab42deb21c36..fe2656937794 100644
--- a/drivers/net/wwan/mhi_wwan_ctrl.c
+++ b/drivers/net/wwan/mhi_wwan_ctrl.c
@@ -109,6 +109,7 @@ int mhi_wwan_dtr_set(struct wwan_port *port, int dtr, int rts);
 static int mhi_wwan_ctrl_start(struct wwan_port *port)
 {
 	struct mhi_wwan_dev *mhiwwan = wwan_port_get_drvdata(port);
+	enum wwan_port_type type;
 	int ret;
 
 	/* Start mhi device's channel(s) */
@@ -125,8 +126,11 @@ static int mhi_wwan_ctrl_start(struct wwan_port *port)
 		mhi_wwan_ctrl_refill_work(&mhiwwan->rx_refill);
 	}
 
-	dev_dbg(&mhiwwan->mhi_dev->dev, "Setting DTR and RTS for port\n");
-	mhi_wwan_dtr_set(port, 1, 1);
+	type = wwan_port_get_type(port);
+	if (type == WWAN_PORT_AT) {
+		dev_dbg(&mhiwwan->mhi_dev->dev, "Setting DTR and RTS for port\n");
+		mhi_wwan_dtr_set(port, 1, 1);
+	}
 
 	return 0;
 }
@@ -134,11 +138,13 @@ static int mhi_wwan_ctrl_start(struct wwan_port *port)
 static void mhi_wwan_ctrl_stop(struct wwan_port *port)
 {
 	struct mhi_wwan_dev *mhiwwan = wwan_port_get_drvdata(port);
-	struct mhi_device *mhi_dev = mhiwwan->mhi_dev;
-	struct mhi_controller *cntrl = mhi_dev->mhi_cntrl;
+	enum wwan_port_type type;
 
-	dev_dbg(&mhiwwan->mhi_dev->dev, "Unsetting DTR and RTS for port\n");
-	mhi_wwan_dtr_set(port, 0, 0);
+	type = wwan_port_get_type(port);
+	if (type == WWAN_PORT_AT) {
+		dev_dbg(&mhiwwan->mhi_dev->dev, "Unsetting DTR and RTS for port\n");
+		mhi_wwan_dtr_set(port, 0, 0);
+	}
 
 	spin_lock_bh(&mhiwwan->rx_lock);
 	clear_bit(MHI_WWAN_RX_REFILL, &mhiwwan->flags);
-- 
2.37.1

